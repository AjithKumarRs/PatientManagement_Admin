@using PatientManagement.PatientManagement

@{
    ViewData["Title"] = "Dashboard";
    ViewData["PageId"] = "Dashboard";
}

@section ContentHeader {
    <h1>@LocalText.Get("Navigation.Dashboard")<small>@Html.Raw(Texts.Site.Dashboard.ContentDescription)</small></h1>
}

@section Head {
    <link rel="stylesheet" href="~/Scripts/fullcalendar/fullcalendar.min.css">
    <link rel="stylesheet" href="~/Scripts/fullcalendar/fullcalendar.print.css" media="print">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.2/moment.min.js"></script>
    <script src="~/Scripts/fullcalendar/fullcalendar.min.js"></script>
    <script src="~/Scripts/adminlte/demo.js"></script>
    <script src="~/Scripts/jquery-migrate-3.0.0.js"></script>

}

<div class="row">
    <div class="col-md-5">
        <div class="col-md-12">
            <div class="box box-solid box-primary">
                <div class="box-body dashboard-visitsgrid">
                    <div id="VisitsGridDiv"></div>

                    <script type="text/javascript">
                        jQuery(function () {
                            new PatientManagement.PatientManagement.CalendarVisitsGrid($('#VisitsGridDiv'), {}).init();

                            Q.initFullHeightGridPage($('#VisitsGridDiv'));
                        });
                    </script>
                </div>
            </div>


        </div>
    </div><!-- /.col -->
    <div class="col-md-7">
        <div class="box box-primary">
            <div class="box-body no-padding">
                <!-- THE CALENDAR -->
                <div id="calendar"></div>
            </div><!-- /.box-body -->
        </div><!-- /. box -->
    </div><!-- /.col -->
</div><!-- /.row -->

<script>
    function FormatAlertMessage(title, startDate, endDate) {
        var str = Q.text("Site.Dashboard.AlertOnCalendarChange") + "\n " +
            Q.text("Site.Dashboard.CalendarPatient")+ " " +  title + "\n" +
            Q.text("Site.Dashboard.CalendarStartDate") + " " + startDate.format("DD.MM.YYYY HH:mm:ss") + "\n" +
            Q.text("Site.Dashboard.CalendarEndDate") + " " + endDate.format("DD.MM.YYYY HH:mm:ss");
        return str;
    } 

    $(function () {
        
        /* initialize the calendar   -----------------------------------------------------------------*/
        $('#calendar').fullCalendar({
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,agendaWeek,agendaDay, listWeek'
            },
            defaultView: 'agendaWeek',
            eventClick: function (event) {
                
                new PatientManagement.PatientManagement.CalendarPatientDialog().loadByIdAndOpenDialog(event.patientId);
                if (event.url) {
                    return false;
                }
            }, 

            //events: visitsModel,
            editable: true,
            droppable: true, // this allows things to be dropped onto the calendar !!!
            eventDrop: function (event, dayDelta, minuteDelta, allDay, revertFunc) {
                
                if (!confirm(FormatAlertMessage(event.title, event.start, event.end))) {
                    revertFunc();
                }

                // Call Function to update the visit
                var dialog = new PatientManagement.PatientManagement.CalendarVisitsDialog();
                dialog.updateVisit(event.id, event.start.format("YYYY-MM-DD HH:mm:ss"), event.end.format("YYYY-MM-DD HH:mm:ss"));

            },
            eventResize: function(event,dayDelta,minuteDelta,revertFunc) {

                if (!confirm(FormatAlertMessage(event.title, event.start, event.end))) {
                    revertFunc();
                }
                var dialog = new PatientManagement.PatientManagement.CalendarVisitsDialog();

                dialog.updateVisit(event.id, event.start.format("YYYY-MM-DD HH:mm:ss"), event.end.format("YYYY-MM-DD HH:mm:ss"));
                

            }
           

        });
        $('#calendar').fullCalendar('addEventSource', "/Dashboard/GetVisitsTasks/");
    });
</script>
