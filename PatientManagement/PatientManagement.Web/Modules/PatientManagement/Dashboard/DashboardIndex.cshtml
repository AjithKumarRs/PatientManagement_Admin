@using PatientManagement.PatientManagement

@{
    ViewData["Title"] = "Dashboard";
    ViewData["PageId"] = "Dashboard";
}

@section ContentHeader {
    <h1>@LocalText.Get("Navigation.Dashboard")<small>@Html.Raw(Texts.Site.Dashboard.ContentDescription)</small></h1>
}

@section Head {
    <link rel="stylesheet" href="~/Scripts/fullcalendar/fullcalendar.min.css">
    <link rel="stylesheet" href="~/Scripts/fullcalendar/fullcalendar.print.css" media="print">
    <script src="~/Scripts/fullcalendar/fullcalendar.min.js"></script>
    <script src="~/Scripts/fullcalendar/locale-all.js"></script>
    <script src="~/Scripts/jquery-migrate-3.0.0.js"></script>

}
    
@{
    var localeCalendar = $"../Scripts/fullcalendar/locale/{System.Globalization.CultureInfo.CurrentUICulture.TwoLetterISOLanguageName}.js";
}
<script src="@localeCalendar"></script>
<div class="row">
    @*<div class="col-md-5">
            <div class="col-md-12">
                <div class="box box-solid box-primary">
                    <div class="box-body dashboard-visitsgrid">
                        <div id="VisitsGridDiv"></div>

                        <script type="text/javascript">
                            jQuery(function () {
                                new PatientManagement.PatientManagement.CalendarVisitsGrid($('#VisitsGridDiv'), {}).init();

                                Q.initFullHeightGridPage($('#VisitsGridDiv'));
                            });
                        </script>
                    </div>
                </div>


            </div>
        </div>*@
    <div class="col-md-12">
        <div class="box box-primary">
            <div class="box-body no-padding">
                <!-- THE CALENDAR -->
                <div id="calendar"></div>
            </div><!-- /.box-body -->
        </div><!-- /. box -->
    </div><!-- /.col -->
</div><!-- /.row -->

<script>
    function FormatAlertMessage(title, startDate, endDate) {
        var str = Q.text("Site.Dashboard.AlertOnCalendarChange") + "\n " +
            Q.text("Site.Dashboard.CalendarPatient")+ " " +  title + "\n" +
            Q.text("Site.Dashboard.CalendarStartDate") + " " + startDate.format("DD.MM.YYYY HH:mm:ss") + "\n" +
            Q.text("Site.Dashboard.CalendarEndDate") + " " + endDate.format("DD.MM.YYYY HH:mm:ss");
        return str;
    }

    $(document).ready(function() {
        var initialLocaleCode =  '@System.Globalization.CultureInfo.CurrentUICulture.Name';
        /* initialize the calendar   -----------------------------------------------------------------*/
        $('#calendar').fullCalendar({
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,agendaWeek,agendaDay, listWeek'
            },
            locale: initialLocaleCode,
            buttonIcons: false, // show the prev/next text
            weekNumbers: true,
            navLinks: true, // can click day/week names to navigate views

            defaultView: 'agendaWeek',
            //businessHours: {
            //    dow: [ 1, 2, 3, 4, 5 ], // Monday - Friday

            //    start: '8:00',
            //    end: '20:00'
            //},
            slotDuration: '00:15:00',
            minTime: "07:00:00",
            maxTime: "21:00:00",
            eventClick: function(event) {

                new PatientManagement.PatientManagement.CalendarPatientDialog().loadByIdAndOpenDialog(event.patientId);
                if (event.url) {
                    return false;
                }
            },
            eventLimit: true,
            allDaySlot: false,
            editable: true,
            droppable: false,
            selectable: true,
            selectHelper: true,

            select: function(start, end) {
                var dialog = new PatientManagement.PatientManagement.CalendarVisitsDialog();
                dialog.newPredifinedVisit(start.format("YYYY-MM-DD HH:mm:ss"),end.format("YYYY-MM-DD HH:mm:ss"));

                $('#calendar').fullCalendar('unselect');

            },
            eventDrop: function (event, dayDelta, minuteDelta, allDay, revertFunc) {

                if (!confirm(FormatAlertMessage(event.title, event.start, event.end))) {
                    revertFunc();
                }
                var dialog = new PatientManagement.PatientManagement.CalendarVisitsDialog();
                dialog.updateVisit(event.id, event.start.format("YYYY-MM-DD HH:mm:ss"), event.end.format("YYYY-MM-DD HH:mm:ss"));

            },
            eventResize: function(event,dayDelta,minuteDelta,revertFunc) {

                if (!confirm(FormatAlertMessage(event.title, event.start, event.end))) {
                    revertFunc();
                }
                var dialog = new PatientManagement.PatientManagement.CalendarVisitsDialog();

                dialog.updateVisit(event.id, event.start.format("YYYY-MM-DD HH:mm:ss"), event.end.format("YYYY-MM-DD HH:mm:ss"));


            }


        });
        $('#calendar').fullCalendar('addEventSource', "/Dashboard/GetVisitsTasks/");
        

    });
</script>
